<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KUNIMO | Live Response Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body, html { height: 100%; width: 100%; overflow: hidden; background-color: #000; }

        header {
            background-color: #1a252f; color: white; padding: 0 40px; height: 70px;
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: 0 2px 15px rgba(0,0,0,0.6); position: relative; z-index: 3000;
        }
        .logo a { text-decoration: none; color: white; display: flex; align-items: center; gap: 10px; }
        .nav-tabs { display: flex; gap: 25px; list-style: none; }
        .nav-tabs a { color: #ecf0f1; text-decoration: none; font-size: 0.85rem; text-transform: uppercase; font-weight: 600; }

        #map-container { position: relative; height: calc(100vh - 70px); width: 100%; }
        #map { height: 100%; width: 100%; z-index: 1; }

        /* --- OVERLAYS --- */
        .project-info-overlay {
            position: absolute; bottom: 30px; right: 20px; z-index: 2000;
            background: rgba(26, 37, 47, 0.95); color: white;
            padding: 15px; border-radius: 10px; border-left: 5px solid #4CAF50;
            width: 300px; max-height: 400px; overflow-y: auto; backdrop-filter: blur(10px);
        }
        .report-item { margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; text-transform: uppercase; margin-top: 5px; }
        .status-active { background: #e74c3c; color: white; }
        .status-receded { background: #5a6268; color: #bdc3c7; }

        /* --- MARKER STYLES --- */
        .marker-container { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        /* ACTIVE: Red Teardrop + Breathing */
        .flood-active {
            width: 24px; height: 24px; background: #e74c3c;
            border: 2px solid white; border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg); display: flex; align-items: center; justify-content: center;
            animation: breathe 2.5s ease-in-out infinite;
        }
        .flood-active i { transform: rotate(45deg); font-size: 10px; color: white; }

        /* RECEDED: Simple Grey Dot (No animation, no tick) */
        .flood-receded {
            width: 12px; height: 12px; background: #7f8c8d;
            border: 2px solid #343a40; border-radius: 50%;
            opacity: 0.8;
        }

        @keyframes breathe { 0%, 100% { transform: rotate(-45deg) scale(0.9); } 50% { transform: rotate(-45deg) scale(1.1); } }
    </style>
</head>
<body>

    <header>
        <div class="logo"><a href="index.html"><i class="fas fa-water" style="color:#4CAF50;"></i><h2>KUNIMO</h2></a></div>
        <nav><ul class="nav-tabs">
            <li><a href="index.html" style="color: #4CAF50;">Home</a></li>
            <li><a href="projects.html">Projects</a></li>
            <li><a href="contribute.html">Contribute</a></li>
        </ul></nav>
    </header>

    <div id="map-container">
        <div id="project-overlay" class="project-info-overlay">
            <h4>Live Feed</h4>
            <div id="project-meta">Syncing data...</div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbyCGpe6WJNbc0Zs_z3xgcGLeZOm9ko1JT52kdledakcQRJvZa3oBSZxx2rxMDp06V-2/exec';

        window.onload = function() {
            const map = L.map('map').setView([-13.2, 34.0], 7);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);

            const markerGroup = L.featureGroup().addTo(map);

            fetch(webAppUrl)
                .then(res => res.json())
                .then(data => {
                    let overlayHtml = "";

                    data.forEach(item => {
                        const lat = parseFloat(item.lat);
                        const lon = parseFloat(item.lon);
                        const status = (item.Status || "Active").trim();
                        const isReceded = status.toLowerCase() === 'receded';

                        overlayHtml += `
                            <div class="report-item">
                                <strong>${item.Event}</strong>
                                <small>${item.Date_repoted}</small><br>
                                <span class="status-badge ${isReceded ? 'status-receded' : 'status-active'}">${status}</span>
                            </div>
                        `;

                        if (!isNaN(lat) && !isNaN(lon)) {
                            // Create marker html based on status
                            const markerHtml = isReceded ? 
                                '<div class="flood-receded"></div>' : 
                                '<div class="flood-active"><i class="fas fa-water"></i></div>';
                            
                            const customIcon = L.divIcon({
                                className: 'marker-container',
                                html: markerHtml,
                                iconSize: [30, 30], iconAnchor: [15, 15]
                            });

                            L.marker([lat, lon], { icon: customIcon })
                                .addTo(markerGroup)
                                .bindPopup(`<b>${item.Event}</b><br>Status: ${status}`);
                        }
                    });

                    document.getElementById('project-meta').innerHTML = overlayHtml;
                    if (markerGroup.getLayers().length > 0) map.fitBounds(markerGroup.getBounds(), {padding:[80,80]});
                });
        };
    </script>
</body>
</html>